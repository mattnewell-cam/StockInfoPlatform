<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company.name }} ({{ company.ticker }})</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .prose p { margin-bottom: 1em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">{{ company.name }} ({{ company.ticker }})</h1>

        <!-- Financial Statements Card -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center gap-4 mb-4">
                <label for="stmt" class="text-sm font-medium text-gray-700">Statement</label>
                <select id="stmt" class="rounded-md border-gray-300 shadow-sm text-sm py-1.5 px-3 border focus:border-blue-500 focus:ring-blue-500">
                    <option value="IS">Income Statement</option>
                    <option value="BS">Balance Sheet</option>
                    <option value="CF">Cash Flow</option>
                </select>
            </div>

            <div id="table-is">
                {% include "companies/statement_table.html" with table=IS_table %}
            </div>
            <div id="table-bs" style="display: none;">
                {% include "companies/statement_table.html" with table=BS_table %}
            </div>
            <div id="table-cf" style="display: none;">
                {% include "companies/statement_table.html" with table=CF_table %}
            </div>
        </div>

        <!-- AI Summaries Section -->
        <div class="space-y-6">
            {% if company.description %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Business Description</h2>
                <div id="description-content" class="text-gray-700 text-sm leading-relaxed prose"></div>
            </div>
            {% endif %}

            {% if company.special_sits %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Special Situations</h2>
                <div id="special-sits-content" class="text-gray-700 text-sm leading-relaxed prose"></div>
            </div>
            {% endif %}

            {% if company.writeups %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Write-ups</h2>
                <ul class="space-y-2">
                    {% for url in company.writeups %}
                    <li>
                        <a href="{{ url }}" target="_blank" rel="noopener"
                           class="text-blue-600 hover:text-blue-800 text-sm break-all hover:underline">
                            {{ url }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Table toggle
        (function() {
            const select = document.getElementById("stmt");
            const ids = { IS: "table-is", BS: "table-bs", CF: "table-cf" };

            function show(which) {
                Object.values(ids).forEach(id => document.getElementById(id).style.display = "none");
                document.getElementById(ids[which]).style.display = "block";
            }
            select.addEventListener("change", function() { show(this.value); });
            show(select.value);
        })();
    </script>

    <script>
        // Markdown rendering
        function stripSourceLinks(text) {
            return text
                .replace(/\s*\(\[.*?\]\(https?:\/\/[^\)]+\)\)/g, '')
                .replace(/\s*\[([^\]]+)\]\(https?:\/\/[^\)]+\)/g, '$1');
        }

        function renderMarkdown(elementId, content) {
            const el = document.getElementById(elementId);
            if (el && content) {
                el.innerHTML = marked.parse(stripSourceLinks(content));
            }
        }

        {% if company.description %}
        renderMarkdown('description-content', "{{ company.description|escapejs }}");
        {% endif %}

        {% if company.special_sits %}
        renderMarkdown('special-sits-content', "{{ company.special_sits|escapejs }}");
        {% endif %}
    </script>
</body>
</html>
