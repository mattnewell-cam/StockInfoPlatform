<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company.name }} ({{ company.ticker }})</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .prose p { margin-bottom: 1em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div></div>
            <div>
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-600 mr-4">{{ user.username }}</span>
                    <a href="{% url 'logout' %}" class="text-sm text-blue-600 hover:text-blue-800">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="bg-blue-600 text-white px-4 py-1.5 rounded-md text-sm hover:bg-blue-700">Login</a>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">{{ company.name }} ({{ company.ticker }})</h1>

        <!-- Top Row: Description + Chart -->
        {% if price_data_json != "[]" %}
        <div class="grid grid-cols-3 gap-6 mb-6">
            <!-- Business Description (1/3) -->
            {% if company.description %}
            <div class="col-span-1 bg-white rounded-lg shadow p-6 flex flex-col" style="height: 470px;">
                <h2 class="text-lg font-semibold text-gray-900 mb-3 flex-shrink-0">Business Description</h2>
                <div id="description-content" class="text-gray-700 text-sm leading-relaxed prose overflow-y-auto flex-grow"></div>
            </div>
            {% endif %}

            <!-- Price Chart (2/3) -->
            <div class="{% if company.description %}col-span-2{% else %}col-span-3{% endif %} bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <button data-period="1d" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">1D</button>
                        <button data-period="5d" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">5D</button>
                        <button data-period="1m" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">1M</button>
                        <button data-period="6m" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">6M</button>
                        <button data-period="1y" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 bg-blue-100 border-blue-500">1Y</button>
                        <button data-period="5y" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">5Y</button>
                        <button data-period="max" class="period-btn px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100">Max</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="chart-type" class="text-sm font-medium text-gray-700">Type</label>
                        <select id="chart-type" class="rounded-md border-gray-300 shadow-sm text-sm py-1.5 px-3 border focus:border-blue-500 focus:ring-blue-500">
                            <option value="line">Line</option>
                            <option value="candlestick">Candlestick</option>
                        </select>
                    </div>
                </div>
                <div id="chart-container" style="height: 370px;"></div>
            </div>
        </div>
        {% endif %}

        <!-- Financials + Notes Row -->
        <div class="grid grid-cols-3 gap-6 mb-6">
            <!-- Financial Statements Card (2/3) -->
            <div class="col-span-2 bg-white rounded-lg shadow p-6">
                <div class="flex items-center gap-4 mb-4">
                    <label for="stmt" class="text-sm font-medium text-gray-700">Statement</label>
                    <select id="stmt" class="rounded-md border-gray-300 shadow-sm text-sm py-1.5 px-3 border focus:border-blue-500 focus:ring-blue-500">
                        <option value="IS">Income Statement</option>
                        <option value="BS">Balance Sheet</option>
                        <option value="CF">Cash Flow</option>
                    </select>
                </div>

                <div id="table-is">
                    {% include "companies/statement_table.html" with table=IS_table %}
                </div>
                <div id="table-bs" style="display: none;">
                    {% include "companies/statement_table.html" with table=BS_table %}
                </div>
                <div id="table-cf" style="display: none;">
                    {% include "companies/statement_table.html" with table=CF_table %}
                </div>
            </div>

            <!-- Notes Card (1/3) -->
            <div class="col-span-1 bg-white rounded-lg shadow p-6 flex flex-col relative" style="height: 500px;">
                <h2 class="text-lg font-semibold text-gray-900 mb-3 flex-shrink-0">Notes</h2>

                {% if user.is_authenticated %}
                <!-- Notes Form -->
                <div class="flex-shrink-0 mb-4">
                    <input type="text" id="note-title" placeholder="Title (optional)"
                           class="w-full rounded-md border border-gray-300 px-3 py-1.5 text-sm mb-2 focus:border-blue-500 focus:ring-blue-500">
                    <textarea id="note-content" placeholder="Write a note..." rows="2"
                              class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm mb-2 focus:border-blue-500 focus:ring-blue-500 resize-none"></textarea>
                    <button id="add-note-btn" class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-blue-700 w-full">
                        Add Note
                    </button>
                </div>

                <!-- Notes List -->
                <div id="notes-list" class="overflow-y-auto flex-grow space-y-3">
                    {% for note in notes %}
                    <div class="border-b border-gray-100 pb-3">
                        {% if note.title %}
                        <h3 class="font-medium text-gray-900 text-sm">{{ note.title }}</h3>
                        {% endif %}
                        <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ note.content }}</p>
                        <span class="text-xs text-gray-400">{{ note.created_at|date:"d/m/Y, g:i A" }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-400 text-sm" id="no-notes-msg">No notes yet.</p>
                    {% endfor %}
                </div>

                {% else %}
                <!-- Blurred state for logged out users -->
                <div class="absolute inset-0 bg-white/80 backdrop-blur-sm rounded-lg flex items-center justify-center">
                    <div class="text-center">
                        <p class="text-gray-600 mb-3">Log in to view and add notes</p>
                        <a href="{% url 'login' %}?next={{ request.path }}" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                            Login
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Special Situations -->
        {% if company.special_sits %}
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Special Situations</h2>
            <div id="special-sits-content" class="text-gray-700 text-sm leading-relaxed prose"></div>
        </div>
        {% endif %}

        <!-- Write-ups -->
        {% if company.writeups %}
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Write-ups</h2>
            <ul class="space-y-2">
                {% for url in company.writeups %}
                <li>
                    <a href="{{ url }}" target="_blank" rel="noopener"
                       class="text-blue-600 hover:text-blue-800 text-sm break-all hover:underline">
                        {{ url }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Chart initialization -->
    <script>
        (function() {
            const ticker = "{{ company.ticker }}";
            const allPriceData = {{ price_data_json|safe }};
            const allVolumeData = {{ volume_data_json|safe }};

            if (allPriceData.length === 0) return;

            const container = document.getElementById('chart-container');
            if (!container) return;

            let chart = null;
            let currentPeriod = '1y';
            let currentChartType = 'line';
            let currentPriceData = [];
            let currentVolumeData = [];

            function filterByPeriod(priceData, volumeData, period) {
                const now = new Date();
                let cutoff;

                switch (period) {
                    case '1m':
                        cutoff = new Date(now.setMonth(now.getMonth() - 1));
                        break;
                    case '6m':
                        cutoff = new Date(now.setMonth(now.getMonth() - 6));
                        break;
                    case '1y':
                        cutoff = new Date(now.setFullYear(now.getFullYear() - 1));
                        break;
                    case '5y':
                        cutoff = new Date(now.setFullYear(now.getFullYear() - 5));
                        break;
                    case 'max':
                    default:
                        return { priceData, volumeData };
                }

                const cutoffStr = cutoff.toISOString().split('T')[0];
                const filteredPrice = priceData.filter(d => d.time >= cutoffStr);
                const filteredVolume = volumeData.filter(d => d.time >= cutoffStr);

                return { priceData: filteredPrice, volumeData: filteredVolume };
            }

            function createChart(priceData, volumeData, chartType, isIntraday = false) {
                if (chart) {
                    chart.remove();
                }

                chart = LightweightCharts.createChart(container, {
                    layout: {
                        background: { type: 'solid', color: '#ffffff' },
                        textColor: '#333',
                    },
                    grid: {
                        vertLines: { color: '#f0f0f0' },
                        horzLines: { color: '#f0f0f0' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Magnet,
                    },
                    handleScroll: false,
                    handleScale: false,
                    rightPriceScale: {
                        borderColor: '#e0e0e0',
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.25,
                        },
                    },
                    timeScale: {
                        borderColor: '#e0e0e0',
                        timeVisible: isIntraday,
                    },
                });

                if (chartType === 'candlestick') {
                    const priceSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: '#26a69a',
                        downColor: '#ef5350',
                        borderUpColor: '#26a69a',
                        borderDownColor: '#ef5350',
                        wickUpColor: '#26a69a',
                        wickDownColor: '#ef5350',
                    });
                    priceSeries.setData(priceData);
                } else {
                    const lineData = priceData.map(d => ({ time: d.time, value: d.close }));
                    const priceSeries = chart.addSeries(LightweightCharts.LineSeries, {
                        color: '#2962FF',
                        lineWidth: 2,
                    });
                    priceSeries.setData(lineData);
                }

                const volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                    priceFormat: { type: 'volume' },
                    priceScaleId: 'volume',
                });
                chart.priceScale('volume').applyOptions({
                    scaleMargins: { top: 0.85, bottom: 0 },
                });
                volumeSeries.setData(volumeData);

                chart.timeScale().fitContent();
            }

            async function fetchIntraday(period) {
                try {
                    const response = await fetch(`/companies/${ticker}/prices/${period}/`);
                    const data = await response.json();
                    if (data.error) {
                        console.error(data.error);
                        return null;
                    }
                    return data;
                } catch (e) {
                    console.error(e);
                    return null;
                }
            }

            async function updatePeriod(period) {
                currentPeriod = period;

                document.querySelectorAll('.period-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'border-blue-500');
                    if (btn.dataset.period === period) {
                        btn.classList.add('bg-blue-100', 'border-blue-500');
                    }
                });

                if (period === '1d' || period === '5d') {
                    const data = await fetchIntraday(period);
                    if (data && data.price_data.length > 0) {
                        currentPriceData = data.price_data;
                        currentVolumeData = data.volume_data;
                        createChart(currentPriceData, currentVolumeData, currentChartType, true);
                    }
                } else {
                    const filtered = filterByPeriod(allPriceData, allVolumeData, period);
                    currentPriceData = filtered.priceData;
                    currentVolumeData = filtered.volumeData;
                    createChart(currentPriceData, currentVolumeData, currentChartType, false);
                }
            }

            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => updatePeriod(btn.dataset.period));
            });

            const chartTypeSelect = document.getElementById('chart-type');
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', function() {
                    currentChartType = this.value;
                    const isIntraday = currentPeriod === '1d' || currentPeriod === '5d';
                    createChart(currentPriceData, currentVolumeData, currentChartType, isIntraday);
                });
            }

            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container || !chart) return;
                const { width, height } = entries[0].contentRect;
                chart.applyOptions({ width, height });
            }).observe(container);

            updatePeriod('1y');
        })();
    </script>

    <script>
        // Table toggle
        (function() {
            const select = document.getElementById("stmt");
            const ids = { IS: "table-is", BS: "table-bs", CF: "table-cf" };

            function show(which) {
                Object.values(ids).forEach(id => document.getElementById(id).style.display = "none");
                document.getElementById(ids[which]).style.display = "block";
            }
            select.addEventListener("change", function() { show(this.value); });
            show(select.value);
        })();
    </script>

    <script>
        // Markdown rendering
        function stripSourceLinks(text) {
            return text
                .replace(/\s*\(\[.*?\]\(https?:\/\/[^\)]+\)\)/g, '')
                .replace(/\s*\[([^\]]+)\]\(https?:\/\/[^\)]+\)/g, '$1');
        }

        function renderMarkdown(elementId, content) {
            const el = document.getElementById(elementId);
            if (el && content) {
                el.innerHTML = marked.parse(stripSourceLinks(content));
            }
        }

        {% if company.description %}
        renderMarkdown('description-content', "{{ company.description|escapejs }}");
        {% endif %}

        {% if company.special_sits %}
        renderMarkdown('special-sits-content', "{{ company.special_sits|escapejs }}");
        {% endif %}
    </script>

    {% if user.is_authenticated %}
    <script>
        // Notes functionality
        (function() {
            const ticker = "{{ company.ticker }}";
            const addBtn = document.getElementById('add-note-btn');
            const titleInput = document.getElementById('note-title');
            const contentInput = document.getElementById('note-content');
            const notesList = document.getElementById('notes-list');
            const noNotesMsg = document.getElementById('no-notes-msg');

            if (!addBtn) return;

            addBtn.addEventListener('click', async function() {
                const title = titleInput.value.trim();
                const content = contentInput.value.trim();

                if (!content) {
                    alert('Please enter a note.');
                    return;
                }

                try {
                    const response = await fetch(`/companies/${ticker}/notes/add/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Remove "no notes" message if present
                        if (noNotesMsg) {
                            noNotesMsg.remove();
                        }

                        // Create new note element
                        const noteEl = document.createElement('div');
                        noteEl.className = 'border-b border-gray-100 pb-3';
                        noteEl.innerHTML = `
                            ${data.title ? `<h3 class="font-medium text-gray-900 text-sm">${data.title}</h3>` : ''}
                            <p class="text-gray-700 text-sm whitespace-pre-wrap">${data.content}</p>
                            <span class="text-xs text-gray-400">${data.created_at}</span>
                        `;

                        // Insert at top of notes list
                        notesList.insertBefore(noteEl, notesList.firstChild);

                        // Clear inputs
                        titleInput.value = '';
                        contentInput.value = '';
                    } else {
                        alert(data.error || 'Failed to add note.');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Failed to add note.');
                }
            });
        })();
    </script>
    {% endif %}
</body>
</html>
